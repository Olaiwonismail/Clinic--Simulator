import { NextResponse } from "next/server";

const caseData = `
Station 14: Telephone consultation

Patient's name: Ciaran O'Sullivan

Age: 4-years, 2 months-old male

Past medical history:
- Born through normal vagina delivery
- Otitis media 9 months ago, treated with PO amoxicillin

Drug history
- No known drug allergy
- Not on any current medication

Recent notes/ consultation
9 months ago – seen by Nurse Kate Wilton (Nurse Access role):
- Second dose of MMR vaccine given
- Advised to book a separate appointment for 4-in-1 pre-school booster

Caller: Mother – Siohban Donnelly
Reason for Appointment: Booked to discuss ongoing concerns regarding Ciaran

Patient's story (Role Player's Brief)
You are the mother of Ciaran and are calling to discuss ongoing sleep difficulties.
Ciaran has been struggling with sleep for the past 4–5 weeks. He has trouble falling
asleep and, even when he does, he often wakes up during the night and comes into
your room. This disturbs your sleep as well, which is now becoming a problem.

ONLY SAY BELOW IF ASKED
Previously, Ciaran had a consistent bedtime of 7pm, but now he doesn't go to bed
until 10 or even 11pm. He often uses his tablet late at night to watch animations. He
also enjoys fizzy drinks, which he sometimes has in the evening.
You recently received a promotion at work, which means longer and more
demanding hours. Your mum helps look after Ciaran — she picks him up from
nursery, and you collect him from her place on your way home from work. Ciaran
has just started nursery.
The only major change recently is your increased work commitment, with early starts
and late finishes. You're a single parent and are trying hard to build a better future for
Ciaran.

72

Social history – You live at home with Ciaran (no one else in the household)

Pregnancy, Birth, Immunisation, nutrition and development - Born at term, no complications. Immunisations up to date (except pending pre-school booster). Eating and developing well

Respond "NO" to any other symptom enquiries

Idea- You think Ciaran has insomnia

Concerns- You are worried because his sleep is affecting your own rest and functioning

Expectations- You would like Ciaran to be prescribed sleeping tablets.

If asked directly about your own wellbeing, mention that you feel stressed, anxious, and low in mood

Questions for the doctor
If the doctor refuses to prescribe sleeping tablets, you ask:
"Can I try Piriton? My friend's child was given it for eczema, and it helped them sleep."

Marking Scheme.
Data Gathering and Diagnosis
- Ask when the sleep issue first started (to establish duration and assess for chronic insomnia)
- Ask if the child has difficulty falling asleep, staying asleep, or both (to characterise the sleep pattern and define the problem)
- Ask how many times per week the sleep problem occurs (≥3 times/week for ≥3 months supports diagnosis of childhood insomnia)
- Ask if sleep was normal before the problem started (helps identify if this is a new or ongoing issue)
- Ask if there have been any recent changes in circumstances of the childlike bereavement, divorce of parents, recent house move, recent change in school or teacher in school etc. (to assess for psychological stressors or environmental changes)
- Ask if the child has a fear of being alone (screening for separation anxiety or nighttime fears)
- Ask if the child sleeps during the day (excessive daytime sleep can reduce night-time sleep drive)
- Ask how many total hours of sleep the child gets in 24 hours (to assess adequacy of overall sleep)

73

- Ask about sleeping disorders for example, ask if the child wakes up suddenly shouting or crying at night (screening for night terrors or nightmares), ask if the child has a history of sleepwalking (important for safety and differential diagnosis)
- Ask if the child shows signs of hyperactivity, poor focus, or impulsive behaviour (screening for ADHD, which is associated with sleep disturbance)
- Ask if the child has difficulty interacting or communicating with others (screening for autism spectrum disorder, also linked with poor sleep)
- Ask if the child snores at night or episodes of choking or gasping during sleep (may indicate sleep-disordered breathing or sleep apnoea)
- Ask if the room is suitable for sleep (to identify environmental factors like noise/light/comfort)
- Ask if anyone shares the room with the child (room sharing can impact sleep patterns or disturbances)
- Ask if the child uses an iPad or electronic device at night (screen time before bed is a major cause of delayed sleep onset)
- Ask if the child consumes fizzy or caffeinated drinks (caffeine can significantly impair sleep in children)
- Ask about pregnancy, birth, immunisation, nutrition, and development (PBIND) (to ensure there are no underlying developmental or health concerns)
- Ask if the mother feels stressed, low in mood or anxious because of this issue (parental stress can impact both parent and child wellbeing)
- Ask if any measures or strategies have already been tried at home (to assess prior interventions and guide next steps)
- Give a diagnosis of likely poor sleep hygiene causing sleep disturbance

Example of explanation to patient's mother
_Sjobhan, thank you for calling today and for sharing how things have been with Ciaran. It sounds like you're juggling a lot right now with your new role and parenting on your own, and I can hear how exhausting this has been for you._
_From what you've described — the late nights, his use of the tablet before bed, and the fizzy drinks , this really sounds like a case of poor sleep hygiene, which is very common in children, especially when routines change._
_Sleeping tablets,including Piriton, are not recommended for sleep problems in children, as they can make things worse in the long run and don't teach children how to fall asleep naturally._
_What will really help is getting Ciaran back into a consistent sleep routine. That means having a set bedtime each night, ideally earlier than 10 or 11pm, with a calm wind-down period before bed; like a bath and a short story, and no screens or_

74

animations at least an hour before bedtime. The light from tablets can interfere with
his brain's natural sleep signal.
It's also best to avoid fizzy drinks in the evening, as the sugar and caffeine can keep
him wired for hours.
If he wakes up and comes into your room, gently walk him back to bed, even if it
takes a few nights of doing this consistently, most children begin to settle with a
routine. A small night light may help if he's afraid of the dark.
I understand this is hard, especially when you're feeling stretched yourself. If you like,
we can talk about how you're coping too, and I'd be happy to book you in for a chat
just to check in on your wellbeing.
For now, I'll also recommend a sleep diary so we can track what's happening, and
let's book a follow-up in 4 weeks to see how things are going. We can always adjust
the plan if needed.

Management
- Advise on good sleep hygiene: Encourage the child to go to bed and wake up
at the same time every day, including weekends.
- Advise mum to establish a consistent, calming bedtime routine: This could
include quiet time, a warm bath, followed by a short bedtime story. The
routine should end with the child falling asleep independently, without needing
a parent in the room.
- If the child wakes up and comes into mum's room during the night, advise her
to gently return the child to their bed, offer reassurance (e.g., a kiss goodnight
and a promise to check in shortly), then leave the room.
- If the child is afraid of the dark, suggest using a night light.
- Advise to avoid screen time (phones, tablets, laptops, TV) for at least 30–60
minutes before bedtime, as screen light can disrupt the child's ability to fall
asleep.
- Advise to avoid fizzy or caffeinated drinks, particularly in the evening.
- If sleep hygiene has already been attempted, ask mum specifically what
strategies have been tried, reinforce those that help, and advise on any key
steps that have not yet been implemented.
- Suggest keeping a sleep diary to help identify patterns, triggers, or
behaviours that may be contributing to poor sleep.
- Explain that sleeping tablets are not suitable for children with sleep issues and
may worsen sleep quality in the long term.
- Recommend avoiding long daytime naps, especially in the late afternoon.
Encourage regular physical activity during the day to promote natural
tiredness in the evening.

75

- Recommend the Headspace app (or similar) to mum to help her manage stress and build healthy coping techniques.
- Advise mum to book a separate appointment to discuss her anxiety and low mood, as this may also be affecting both her and the child's wellbeing.
- Arrange a follow-up appointment in 4 weeks to assess for improvement or to reassess the situation.

Learning Point from This Station
Sleep difficulties in young children are common and often related to poor sleep hygiene rather than medical causes. A thorough, structured history is essential to rule out contributing factors such as screen use, caffeine intake, emotional stress, and disrupted routines.
Key management involves educating parents on behavioural strategies and routine-based interventions, rather than medications. Sedating antihistamines like chlorphenamine (Piriton) are not recommended for sleep issues in children and may cause more harm than benefit.
It is important to consider underlying conditions such as ADHD and autism, which are both strongly associated with sleep disturbances. In children with these conditions, if sleep hygiene measures have been tried without success, a discussion with a specialist regarding the initiation of melatonin may be appropriate.
A sleep diary can be a valuable tool to monitor sleep patterns, identify triggers, and guide management over time.
Children presenting with suspected sleep disorders, such as frequent nightmares, sleep talking, sleepwalking, or excessive daytime sleepiness, should be referred immediately for specialist assessment, as these may point to more serious underlying sleep disorders.
This case also highlights the need to assess parental wellbeing, as maternal stress, low mood, and anxiety can indirectly contribute to the child's sleep difficulties. A holistic and family-centred approach, with behavioural advice, follow-up, and emotional support, is essential for effective and safe management.

Further Reading
https://patient.info/doctor/sleep-problems-in-children
https://qpnotebook.com/en-GB/pages/psychiatry/inomnia-in-children

76
`;
const prompt = `
You are a patient roleplaying AI. Use the provided reference named "caseData" as your primary guideline for answers.
Use conversation history to follow the progress of the conversation and maintain context.

When caseData provides relevant information, prioritize and align your answers with it.
If caseData lacks necessary details, you may use your own knowledge, but remain consistent with caseData's style, logic, and intent.

Always output only valid JSON (no markdown, no code fences, no commentary). The JSON must match this exact structure:

{
  "text": "your answer here",
  "tone": "automatically inferred from the style of the reference caseData"
}

Rules:
- "text" must contain the assistant's reply as plain text (escape quotes as needed).
- "tone" must be a short label inferred from caseData's style (e.g., formal, casual, instructional, concerned).
- If caseData is missing info and you use external knowledge, still return the same JSON shape.
- If you cannot answer even after using external knowledge, return exactly:
  {"text":"The caseData does not contain enough information to answer this question.","tone":"neutral"}

Do NOT include any extra text, markdown, code fences, logs, or explanations — output ONLY the JSON object above.
`;




export async function POST(request: Request) {
  try {
    const { text, history } = await request.json();
    console.log("Received text:", text);
    if (!text) {
      return NextResponse.json({ error: "Missing 'text' field" }, { status: 400 });
    }

    const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
    if (!GEMINI_API_KEY) {
      return NextResponse.json({ error: "Missing Gemini API key" }, { status: 500 });
    }

    const response = await fetch(
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-goog-api-key": GEMINI_API_KEY,
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [{ 
                text: `${caseData}${prompt}${history}${text}`
             }],
            },
          ],
        }),
      }
    );

    const data = await response.json();
    // console.log("Gemini API response:", data);
    return NextResponse.json(data);
  } catch (error: any) {
    console.error("Error calling Gemini API:", error);
    return NextResponse.json(
      { error: "Failed to call Gemini API", details: error.message },
      { status: 500 }
    );
  }
}
